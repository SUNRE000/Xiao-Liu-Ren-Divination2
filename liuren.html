<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c3e50">
    <title>小六壬占卜</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .datetime-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            color: #2c3e50;
            transition: border-color 0.3s;
        }

        .datetime-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            background: white;
            color: #7f8c8d;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .time-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        .time-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .calculation {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
            color: #2c3e50;
        }

        .result {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .result-description {
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.95;
        }

        .refresh-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 26px;
            }

            .result-title {
                font-size: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>小六壬占卜</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label for="dateInput">選擇日期時間：</label>
                <input type="datetime-local" id="dateInput" class="datetime-input">
            </div>
            <div class="button-group">
                <button class="mode-btn active" id="currentBtn" onclick="useCurrentTime()">使用當前時間</button>
                <button class="mode-btn" id="customBtn" onclick="useCustomTime()">使用自訂時間</button>
            </div>
        </div>
        
        <div class="time-display">
            <div class="time-row">
                <span class="time-label">國曆時間</span>
                <span class="time-value" id="gregorianTime"></span>
            </div>
            <div class="time-row">
                <span class="time-label">農曆日期</span>
                <span class="time-value" id="lunarDate"></span>
            </div>
            <div class="time-row">
                <span class="time-label">時辰</span>
                <span class="time-value" id="timeHour"></span>
            </div>
        </div>

        <div class="calculation" id="calculation"></div>

        <div class="result" id="result">
            <div class="result-title" id="resultTitle"></div>
            <div class="result-description" id="resultDescription"></div>
        </div>

        <button class="refresh-btn" onclick="calculate()">重新計算</button>
    </div>

    <script>
        const lunarMonths = ["正","二","三","四","五","六","七","八","九","十","十一","十二"];
        const timeNames = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];

        const results = [
            { name: "大安", desc: "身不動時，五行屬木，顏色青色，方位東方。臨青龍，謀事主一、五、七。有靜止、心安、吉祥之含義。" },
            { name: "流連", desc: "人未歸時，五行屬水，顏色黑色，方位北方。臨玄武，謀事主二、八、十。有暗昧不明、延遲、糾纏、拖延之含義。" },
            { name: "速喜", desc: "人即至時，五行屬火，顏色紅色，方位南方。臨朱雀，謀事主三、六、九。有快速、喜慶、吉利之含義。" },
            { name: "赤口", desc: "官事兇時，五行屬金，顏色白色，方位西方。臨白虎，謀事主四、七、十。有不吉、驚恐、凶險之含義。" },
            { name: "小吉", desc: "人來喜時，五行屬木，顏色青色，方位東方。臨六合，謀事主一、五、七。有和合、吉利之含義。" },
            { name: "空亡", desc: "音信稀時，五行屬土，顏色黃色，方位中央。臨勾陳，謀事主三、六、九。有不吉、無結果、憂慮之含義。" }
        ];

        // 當日期輸入改變時自動計算
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('dateInput').addEventListener('change', function() {
                if (this.value) {
                    useCustomTime();
                }
            });
        });

        // 農曆數據表 (1900-2100)
        const lunarInfo = [
            0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
            0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
            0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
            0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
            0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
            0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0,
            0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
            0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b6a0, 0x195a6,
            0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
            0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,
            0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
            0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
            0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
            0x05aa0, 0x076a3, 0x096d0, 0x04afb, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
            0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0,
            0x14b63, 0x09370, 0x049f8, 0x04970, 0x064b0, 0x168a6, 0x0ea50, 0x06b20, 0x1a6c4, 0x0aae0,
            0x0a2e0, 0x0d2e3, 0x0c960, 0x0d557, 0x0d4a0, 0x0da50, 0x05d55, 0x056a0, 0x0a6d0, 0x055d4,
            0x052d0, 0x0a9b8, 0x0a950, 0x0b4a0, 0x0b6a6, 0x0ad50, 0x055a0, 0x0aba4, 0x0a5b0, 0x052b0,
            0x0b273, 0x06930, 0x07337, 0x06aa0, 0x0ad50, 0x14b55, 0x04b60, 0x0a570, 0x054e4, 0x0d160,
            0x0e968, 0x0d520, 0x0daa0, 0x16aa6, 0x056d0, 0x04ae0, 0x0a9d4, 0x0a2d0, 0x0d150, 0x0f252
        ];

        // 獲取農曆年份的總天數
        function lYearDays(y) {
            let sum = 348;
            for (let i = 0x8000; i > 0x8; i >>= 1) {
                sum += (lunarInfo[y - 1900] & i) ? 1 : 0;
            }
            return sum + leapDays(y);
        }

        // 獲取農曆年份的閏月天數
        function leapDays(y) {
            if (leapMonth(y)) {
                return (lunarInfo[y - 1900] & 0x10000) ? 30 : 29;
            }
            return 0;
        }

        // 獲取農曆年份的閏月月份，0表示沒有閏月
        function leapMonth(y) {
            return lunarInfo[y - 1900] & 0xf;
        }

        // 獲取農曆年份某月的天數
        function monthDays(y, m) {
            if (m > 12 || m < 1) return -1;
            return (lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29;
        }

        // 公曆轉農曆
        function solarToLunar(date) {
            const baseDate = new Date(1900, 0, 31);
            let offset = Math.floor((date - baseDate) / 86400000);

            let daysOfYear = 0;
            let lunarYear;
            for (lunarYear = 1900; lunarYear < 2101 && offset > 0; lunarYear++) {
                daysOfYear = lYearDays(lunarYear);
                offset -= daysOfYear;
            }
            if (offset < 0) {
                offset += daysOfYear;
                lunarYear--;
            }

            const leap = leapMonth(lunarYear);
            let isLeap = false;

            let daysOfMonth = 0;
            let lunarMonth;
            for (lunarMonth = 1; lunarMonth < 13 && offset > 0; lunarMonth++) {
                if (leap > 0 && lunarMonth === (leap + 1) && !isLeap) {
                    --lunarMonth;
                    isLeap = true;
                    daysOfMonth = leapDays(lunarYear);
                } else {
                    daysOfMonth = monthDays(lunarYear, lunarMonth);
                }

                offset -= daysOfMonth;
                if (isLeap && lunarMonth === (leap + 1)) isLeap = false;
            }

            if (offset === 0 && leap > 0 && lunarMonth === leap + 1) {
                if (isLeap) {
                    isLeap = false;
                } else {
                    isLeap = true;
                    --lunarMonth;
                }
            }

            if (offset < 0) {
                offset += daysOfMonth;
                --lunarMonth;
            }

            return {
                year: lunarYear,
                month: lunarMonth,
                day: offset + 1,
                isLeap: isLeap
            };
        }

        function getTimeZhi(hour) {
            return Math.floor((hour + 1) / 2) % 12;
        }

        let isCustomMode = false;

        function useCurrentTime() {
            isCustomMode = false;
            document.getElementById('currentBtn').classList.add('active');
            document.getElementById('customBtn').classList.remove('active');
            document.getElementById('dateInput').value = '';
            calculate();
        }

        function useCustomTime() {
            const dateInput = document.getElementById('dateInput');
            if (!dateInput.value) {
                // 設定預設值為當前時間
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const localISOTime = new Date(now - offset).toISOString().slice(0, 16);
                dateInput.value = localISOTime;
            }
            isCustomMode = true;
            document.getElementById('currentBtn').classList.remove('active');
            document.getElementById('customBtn').classList.add('active');
            calculate();
        }

        function calculate() {
            let targetDate;
            
            if (isCustomMode) {
                const dateInput = document.getElementById('dateInput');
                if (dateInput.value) {
                    targetDate = new Date(dateInput.value);
                } else {
                    targetDate = new Date();
                }
            } else {
                targetDate = new Date();
            }

            const lunar = solarToLunar(targetDate);
            const timeZhiIndex = getTimeZhi(targetDate.getHours());
            
            // 顯示時間資訊
            document.getElementById('gregorianTime').textContent = 
                `${targetDate.getFullYear()}年${targetDate.getMonth() + 1}月${targetDate.getDate()}日 ${targetDate.getHours()}:${String(targetDate.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('lunarDate').textContent = 
                `${lunar.year}年${lunar.isLeap ? '閏' : ''}${lunarMonths[lunar.month - 1]}月${lunar.day}日`;
            
            document.getElementById('timeHour').textContent = 
                `${timeNames[timeZhiIndex]}時`;

            // 計算數值（各項減一後再相加）
            const monthNum = lunar.month - 1;
            const dayNum = lunar.day - 1;
            const timeNum = timeZhiIndex;
            const sum = monthNum + dayNum + timeNum;
            const remainder = sum % 6;

            // 顯示計算過程
            document.getElementById('calculation').textContent = 
                `(${lunar.month}-1) + (${lunar.day}-1) + (${timeZhiIndex + 1}-1) = ${monthNum} + ${dayNum} + ${timeNum} = ${sum}　→　${sum} ÷ 6 餘 ${remainder}`;

            // 顯示結果
            const result = results[remainder];
            document.getElementById('resultTitle').textContent = result.name;
            document.getElementById('resultDescription').textContent = result.desc;
        }

        // 頁面載入時執行
        window.onload = calculate;

        // 註冊 Service Worker（需要 HTTPS 或 localhost）
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker 註冊成功'))
                    .catch(err => console.log('Service Worker 註冊失敗', err));
            });
        }
    </script>
</body>
</html>
